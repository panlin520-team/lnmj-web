<form class="timeForm" id="timeForm" action="" <#--lay-filter="example"--> method="post" hidden="true">

    <div class="layui-form">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">护理时间</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="nurseDate" placeholder="yyyy-MM-dd">
                </div>
            </div>
        </div>
    </div>


    <div class="nore_time_list">
        <div class="time">
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="7">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="09:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="8">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="09:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="9">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="09:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="10">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="09:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="11">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="09:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="12">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="09:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="13">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="10:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="14">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="10:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="15">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="10:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="16">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="10:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="17">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="10:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="18">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="10:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="19">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="11:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="20">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="11:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="21">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="11:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="22">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="11:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="23">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="11:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="24">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="11:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="25">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="12:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="26">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="12:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="27">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="12:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="28">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="12:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="29">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="12:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="30">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="12:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="31">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="13:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="32">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="13:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="33">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="13:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="34">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="13:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="35">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="13:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="36">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="13:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="37">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="14:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="38">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="14:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="39">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="14:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="40">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="14:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="41">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="14:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="42">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="14:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="43">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="15:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="44">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="15:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="45">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="15:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="46">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="15:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="47">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="15:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="48">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="15:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="49">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="16:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="50">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="16:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="51">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="16:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="52">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="16:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="53">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="16:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="54">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="16:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="55">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="17:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="56">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="17:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="57">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="17:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="58">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="17:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="59">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="17:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="60">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="17:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="61">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="18:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="62">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="18:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="63">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="18:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="64">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="18:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="65">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="18:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="66">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="18:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="67">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="19:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="68">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="19:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="69">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="19:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="70">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="19:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="71">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="19:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="72">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="19:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="73">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="20:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="74">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="20:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="75">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="20:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="76">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="20:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="77">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="20:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="78">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="20:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="79">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="21:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="80">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="21:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="81">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="21:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="82">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="21:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="83">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="21:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="84">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="21:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="85">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="22:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="86">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="22:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="87">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="22:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="88">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="22:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="89">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="22:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="90">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="22:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="91">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="23:00">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="92">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="23:10">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="93">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="23:20">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="94">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="23:30">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="95">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="23:40">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="96">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="23:50">
            </div>
            <div class="basetime_list">

                <input type="hidden" name="timeid" value="97">
                <input type="hidden" name="isfree" value="">
                <input class="basetime freebg" type="text" name="basetime" value="24:00">
            </div>
        </div>

        <div class="button_branchman">
            <input class="shiftbutton" type="button" value="自动分配" name="shiftbutton">
            <input type="hidden" value="0" name="ifshift">
            <input class="shiftbutton ismixed" name="addbranchman" type="button" value="添加美容师" style="display: inline;">
            <input class="shiftbutton ismixed" name="delbranchman" type="button" value="删除美容师" style="display: inline;">
        </div>


        <div class="nore_time_branchman">
            <label name="chooseNurse">美容师　：</label>
            <select id="branchman" name="branchman" onchange="branchman_option_change(this);">
            </select>
            <input class="performance_rate" type="text" name="performance_rate" value="1">业绩占比
            <input type="radio" name="ismainbranchman" checked="" value="0">是否为主美容师
        </div>


    </div>
</form>
<script>

    $(function () {
        loadPost()
    })

    function addGoodsDetail(table,data) {
        isMatch = 0
        $(".basetime").css("background-color", "#5A7C48")
        //获取美容师排班时间
        orderWorkList = loadBeauticianOrderWork();
            var a1 = layer.open({
                type: 1,
                title: '护理时间',
                content: $("#timeForm"),
                area: ['700px', '700px'],
                btn: ['提交', '取消'],
                yes: function (index, layero) {
                    selectedBeauticianId = new Array();
                    //获取所有选中美容师
                    all_selected_branchman()
                    if (currentNurseDate == "") {
                        layer.msg("请选择护理日期")
                        selectedBeauticianId = new Array();
                        return
                    }
                    if (currentNurseTime == "") {
                        layer.msg("请选择护理时间")
                        selectedBeauticianId = new Array();
                        return
                    }
                    //获取主美容师
                    var main = $('input[name="ismainbranchman"]:checked').parent().find("select option:selected").val()
                    var flag = false;
                    if ($("input[name='Storage']:checked").val() == 1) {
                        for (var n = 0; n < selectedBeauticianId.length; n++) {
                            if (selectedBeauticianId[n].beauticianId == "0") {
                                flag = true;
                            }
                        }
                    }
                    if (selectedBeauticianId.length == 0 || flag) {
                        layer.msg("请选择美容师")
                        selectedBeauticianId = new Array();
                    } else if (isRepeat(selectedBeauticianId)) {
                        layer.msg("请勿选择相同的美容师")
                        selectedBeauticianId = new Array();
                    } else {
                            if (typeof (main) == "undefined") {
                                layer.msg("请选择主美容师")
                                selectedBeauticianId = new Array();
                                return;
                            }
                            //获取业绩占比，然后添加到选定美容师数组对象中
                            get_performance_ratio()
                            //判断业绩占比总和是否为1
                            var total = 0;
                            for (var i = 0; i < selectedBeauticianId.length; i++) {
                                total = total + selectedBeauticianId[i].performanceRate * 1
                            }
                            if (total != 1) {
                                layer.msg("业绩占比分配有误")
                                selectedBeauticianId = new Array();
                                return;
                            }


                        var productCode = data.productCode;
                        var productName = data.productName;
                        var productOriginalPrice = data.productOriginalPrice;
                        var durationTime = data.duration;
                        nameArray = new Array();
                        beauticianIdsArray = new Array();
                        var performanceRatio = new Array();
                        for (var m = 0; m < selectedBeauticianId.length; m++) {
                            if (selectedBeauticianId[m].beauticianId == main) {
                                nameArray.push(selectedBeauticianId[m].name + "(主)")
                                beauticianIdsArray.push(selectedBeauticianId[m].beauticianId + "(主)")
                                performanceRatio.push(selectedBeauticianId[m].performanceRate)
                            } else {
                                nameArray.push(selectedBeauticianId[m].name)
                                beauticianIdsArray.push(selectedBeauticianId[m].beauticianId)
                                performanceRatio.push(selectedBeauticianId[m].performanceRate)
                            }
                        }

                        data2 = {
                            "beauticianIdsArray": beauticianIdsArray,
                            "name": nameArray,
                            "time": currentNurseDate + " " + currentNurseTime,
                            "performanceRatio": performanceRatio
                        }
                        $('.nore_time_branchman').not($(".nore_time_branchman:first")).remove();
                        //修改订单使用次数
                        updateUseTimes(data)
                        //添加使用记录
                        addUseRecord(data, data2)
                        layer.close(a1);
                        table.reload("experiencecardOrderDetail")
                    }
                },
                btn2: function () {
                    $('.nore_time_branchman').not($(".nore_time_branchman:first")).remove();
                    isMatch = 0
                    table.reload("experiencecardOrderDetail")
                },
                success: function (layero) {
                    $(".basetime").prev().val("");
                    selectedBeauticianId = new Array();
                    $(".basetime").attr("readonly", "true")
                    $(".basetime").attr("class", "basetime freebg")
                    $("#nurseDate").val("")
                    currentNurseDate = ""
                    currentNurseTime = ""
                    $(document).off("click", ".basetime").on("click", ".basetime", function () {
                        var thisdata = $(this);
                        var restTimeMan = new Array();
                        var busyTimeMan = new Array();
                        if (currentNurseDate == "") {
                            layer.msg("请选择护理日期")
                            selectedBeauticianId = new Array();
                        } else {
                            if (thisdata.prev().val() == "busy") {
                                layer.msg("美容师繁忙是否强制分配", {
                                    time: 20000, //20s后自动关闭
                                    btn: ['是', '否'],
                                    yes: function (index, layero) {
                                        for (var i = 0; i < orderWorkList.length; i++) {
                                            if (orderWorkList[i].busyTimeNodes.indexOf(thisdata.val()) != -1 && orderWorkList[i].orderworkDate == currentNurseDate) {
                                                busyTimeMan.push(orderWorkList[i].beauticianId)
                                            }
                                        }
                                        layer.close(index);
                                        $(".basetime").attr("class", "basetime freebg")
                                        thisdata.attr("class", "basetime freebg clickbg")
                                        currentNurseTime = thisdata.val();
                                    },
                                    btn2: function () {

                                    }

                                });
                            } else if (thisdata.prev().val() == "rest") {
                                layer.msg("美容师休息是否强制分配", {
                                    time: 20000, //20s后自动关闭
                                    btn: ['是', '否'],
                                    yes: function (index, layero) {
                                        for (var i = 0; i < orderWorkList.length; i++) {
                                            if (orderWorkList[i].restTimeNodes.indexOf(thisdata.val()) != -1 && orderWorkList[i].orderworkDate == currentNurseDate) {
                                                restTimeMan.push(orderWorkList[i].beauticianId)
                                            }
                                        }
                                        layer.close(index);
                                        $(".basetime").attr("class", "basetime freebg")
                                        thisdata.attr("class", "basetime freebg clickbg")
                                        currentNurseTime = thisdata.val();
                                    },
                                    btn2: function () {

                                    }
                                });
                            } else {
                                for (var i = 0; i < orderWorkList.length; i++) {
                                    if (orderWorkList[i].busyTimeNodes.indexOf(thisdata.val()) != -1 && orderWorkList[i].orderworkDate == currentNurseDate) {
                                        busyTimeMan.push(orderWorkList[i].beauticianId)
                                    }
                                }
                                for (var i = 0; i < orderWorkList.length; i++) {
                                    if (orderWorkList[i].restTimeNodes.indexOf(thisdata.val()) != -1 && orderWorkList[i].orderworkDate == currentNurseDate) {
                                        restTimeMan.push(orderWorkList[i].beauticianId)
                                    }
                                }
                                $(".basetime").attr("class", "basetime freebg")
                                thisdata.attr("class", "basetime freebg clickbg")
                                currentNurseTime = thisdata.val();
                            }

                            selectedBeauticianId = new Array();
                            all_selected_branchman()
                            if (isMatch == 0) {
                                //没有排班匹配时才校验美容师
                                    loadBeauticianForOrderWork(restTimeMan, busyTimeMan, postMeirongId)
                            } else if (selectedBeauticianId.length == 0) {
                                    loadBeauticianForOrderWork(restTimeMan, busyTimeMan, postMeirongId)

                            }
                        }
                    });

                    //添加美容师事件绑定
                    $(document).off("click", "input[name='addbranchman']").on("click", "input[name='addbranchman']", function () {
                        if (currentNurseTime != "") {
                            layer.msg("该项目的护理时间已经分配完成 不能添加美容师")
                            return
                        }
                        selectedBeauticianId = new Array();
                        $(".nore_time_branchman:last").after($(".nore_time_branchman:last").clone());
                    });

                    //删除美容师事件绑定
                    $(document).off("click", "input[name='delbranchman']").on("click", "input[name='delbranchman']", function () {
                        selectedBeauticianId = new Array();
                        if ($(".nore_time_branchman").length > 1) {
                            $(".nore_time_branchman:last").remove();
                        }
                        all_selected_branchman()
                        //匹配排班时间
                        if (selectedBeauticianId.length != 0) {
                            //如果至少选择了一个美容师才匹配排班
                            matchOrderTime(currentNurseDate, currentNurseTime, 1)
                        }


                    });

                    //美容师下拉框赋值
                        loadBeauticianForOrder(postMeirongId);
                        $("input[name='performance_rate").text("业绩占比")
                        $("input[name='ismainbranchman").text("是否为主美容师")
                        $("label[name='chooseNurse").text("美容师")



                }
            });
        }

    //获取所有选中美容师
    function all_selected_branchman() {
        var nore_time_branchman = $(".nore_time_branchman");
        for (var i = 0; i < nore_time_branchman.length; i++) {
            if ($(nore_time_branchman[i]).find("select option:selected").val() != 0) {
                var beauticianId = $(nore_time_branchman[i]).find("select option:selected").val()
                var beauticianName = $(nore_time_branchman[i]).find("select option:selected").text()
                var json = {"beauticianId": beauticianId, "name": beauticianName, "performanceRate": ""}
                selectedBeauticianId.push(json)
            }
        }
    }

    //加载美容师排班时间
    function loadBeauticianOrderWork() {
        var url = storeHost + "/manage/orderwork/selectOrderworkAll";
        var data = {"storeId":storeId};
        var resultList = new Array();
        $.ajax({
            url: url,
            type: "post",
            data: data,
            async: false,
            success: function (result) {
                if (result.responseStatusType.message == "Success") {
                    resultList = result.result;    //返回的数据
                } else {
                }
            }
        });
        return resultList
    }

    //加载美容师信息-下单
    function loadBeauticianForOrder(postType) {
        var url = storeHost + "/manage/beautician/selectBeauticianList";
        var data = {"storeId": storeId};
        $.post(url, data, function (result) {
            if (result.responseStatusType.message == "Success") {
                var list = result.result.list;    //返回的数据
                var server = document.getElementById("branchman"); //server为select定义的name
                server.innerHTML = "<option value='0' selected='true'>请选择</option>";
                for (var p in list) {
                    if (list[p].postId == postType) {
                        var option = document.createElement("option");  // 创建添加option属性
                        option.setAttribute("value", list[p].beauticianId); // 给option的value添加值
                        option.innerText = list[p].name;     // 打印option对应的纯文本
                        server.appendChild(option);           //给select添加option子标签
                    }
                }
            } else {

            }
        })
    }

    //加载职位信息
    var postMeirongId
    var postMeifaId
    function loadPost() {
        var url = storeHost + "/manage/beautician/selectPost";
        var data = {};
        $.post(url, data, function (result) {
            if (result.responseStatusType.message == "Success") {
                var list = result.result.list;    //返回的数据
                for (p in list) {
                    if (list[p].name == "美容师") {
                        postMeirongId = list[p].postId
                    } else if (list[p].name == "美发师") {
                        postMeifaId = list[p].postId
                    }
                }
            } else {

            }
        })
    }

    //判断数组是否有重复
    function isRepeat(arr) {
        var newArray = new Array();
        for (var i = 0; i < arr.length; i++) {
            newArray.push(arr[i].beauticianId)
        }
        var nary = newArray.sort();
        for (var i = 0; i < newArray.length; i++) {
            if (nary[i] == nary[i + 1]) {
                return true;
            }
        }
    }
    //加载美容师信息-下单-点击时间判断排班后
    function loadBeauticianForOrderWork(restTimeMan, busyTimeMan, postType) {
        var url = storeHost + "/manage/beautician/selectBeauticianList";
        var data = {"storeId": storeId};
        $.post(url, data, function (result) {
            if (result.responseStatusType.message == "Success") {
                var list = result.result.list;    //返回的数据
                $("select[name='branchman']").each(function () {
                    $(this).html("<option value='0' selected='true'>请选择</option>");
                    for (var p in list) {
                        if (list[p].postId == postType) {
                            var option = document.createElement("option");  // 创建添加option属性
                            option.setAttribute("value", list[p].beauticianId); // 给option的value添加值
                            if (restTimeMan.indexOf(list[p].beauticianId) != -1) {
                                option.innerText = list[p].name + "(休)";     // 打印option对应的纯文本
                                option.style.color = "#4963ff"
                                option.setAttribute("data-isdisable", "no");
                            } else if (busyTimeMan.indexOf(list[p].beauticianId) != -1) {
                                option.innerText = list[p].name + "(忙)";     // 打印option对应的纯文本
                                option.style.color = "#ff4646"
                                option.setAttribute("data-isdisable", "no");
                            } else {
                                option.innerText = list[p].name
                            }
                            $(this).append(option);
                        }
                    }
                })
            } else {

            }
        })
    }
    //单选变化的时候清空数组
    function branchman_option_change(data) {
        selectedBeauticianId = new Array();
        all_selected_branchman()
        //匹配排班时间
        if (currentNurseTime == "") {
            //如果还没选择时间节点
            matchOrderTime(currentNurseDate, currentNurseTime, 0)
            return
        }

        if (selectedBeauticianId.length == 0) {

            $(".basetime").css("background-color", "#5A7C48")
            $(".basetime").prev().val("");
            return
        }

    }
    //美容师匹配排班时间
    function matchOrderTime(currentNurseDate, currentNurseTime, isDelete) {
        $(".basetime").css("background-color", "#5A7C48")
        $(".basetime").prev().val("");
        if ((currentNurseDate != "" && currentNurseTime == "") || (currentNurseDate != "" && isDelete == 1)) {
            //如果选择了日期，没有选择时间节点，那么匹配排班
            var jsonArray = new Array();
            for (var i = 0; i < selectedBeauticianId.length; i++) {
                for (var n = 0; n < orderWorkList.length; n++) {
                    if (selectedBeauticianId[i].beauticianId == orderWorkList[n].beauticianId && orderWorkList[n].orderworkDate == currentNurseDate) {
                        var json = {};
                        json.beauticianId = selectedBeauticianId[i].beauticianId
                        json.busyTimeNodesArray = orderWorkList[n].busyTimeNodes
                        json.restTimeNodesArray = orderWorkList[n].restTimeNodes
                        jsonArray.push(json)
                    }
                }
            }

            for (var b = 0; b < jsonArray.length; b++) {
                $(".basetime_list").each(function () {
                    var busyTimeNodesArray = new Array()
                    busyTimeNodesArray = jsonArray[b].busyTimeNodesArray;
                    if (busyTimeNodesArray.indexOf($(this).find("input[name='basetime']").val()) != -1) {
                        $(this).find("input[name='basetime']").css("background-color", "#F58100")
                        $(this).find("input[name='isfree']").val("busy")
                    }
                })
            }


            for (var r = 0; r < jsonArray.length; r++) {
                $(".basetime_list").each(function () {
                    var restTimeNodesArray = new Array()
                    restTimeNodesArray = jsonArray[r].restTimeNodesArray;
                    if (restTimeNodesArray.indexOf($(this).find("input[name='basetime']").val()) != -1) {
                        $(this).find("input[name='basetime']").css("background-color", "#B2B2B2")
                        $(this).find("input[name='isfree']").val("rest")
                    }
                })
            }
            //标记为已经匹配了时间节点
            isMatch = 1;
        }
    }
    //获取业绩占比
    function get_performance_ratio() {
        var nore_time_branchman = $(".nore_time_branchman");
        selectedBeauticianId = new Array();
        all_selected_branchman()
        for (var i = 0; i < nore_time_branchman.length; i++) {
            var performanceRate = $(nore_time_branchman[i]).find("input[type='text']").val();
            selectedBeauticianId[i].performanceRate = performanceRate
        }
    }

    //关于时间范围的js
    layui.use('laydate', function () {
        var laydate = layui.laydate;
        //常规用法
        laydate.render({
            elem: '#nurseDate'
            , done: function (value, date) {
                isMatch = 0
                currentNurseDate = value;
                currentNurseTime = "";
                $(".basetime").attr("class", "basetime freebg")
                //匹配排班时间
                if (selectedBeauticianId.length != 0) {
                    //如果至少选择了一个美容师才匹配排班
                    matchOrderTime(currentNurseDate, currentNurseTime, 0)
                }

            }
        });
    });


</script>
