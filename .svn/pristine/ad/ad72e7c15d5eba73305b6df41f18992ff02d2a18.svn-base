<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>商品小类</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="${basePath!}/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="${basePath!}/css/index.css" media="all"/>
    <script src="${basePath!}/js/jquery.min.js" type="text/javascript"></script>
    <script src="${basePath!}/layui/layui.js" charset="utf-8"></script>
    <script src="${basePath!}/js/host.js" type="text/javascript"></script>
    <#include "../../baseFtl/pageAuth.ftl" />
    <style>
        .resetLabel {
            width: 30px;
        }

        label.xrequired:before {
            content: '* ';
            color: red;
        }
    </style>
</head>
<body>

<div class="layui-fluid">
    <div class="demoTable layui-form" lay-filter="demoTable">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">商品大类</label>
                <div class="layui-input-inline">
                    <select name="commodityTypeSearch" lay-filter="commodityTypeSearch" lay-verify="required">
                        <option value="0">请选择</option>
                    </select>
                </div>
            </div>
            <#--<div class="layui-inline">-->
            <#--<label class="layui-form-label">业绩</label>-->
            <#--<div class="layui-input-inline">-->
            <#--<select name="subclassAchievement" id="subclassAchievement" lay-filter="subclassAchievement"-->
            <#--lay-verify="required">-->
            <#--<option value="">请选择</option>-->
            <#--</select>-->
            <#--</div>-->
            <#--</div>-->
            <div class="layui-inline">
                <label class="layui-form-label">客户测评</label>
                <div class="layui-input-inline">
                    <select name="subclassEvaluating" lay-filter="subclassEvaluating" lay-verify="required">
                        <option value="0">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <button class="layui-btn" data-type="search"><i class="layui-icon layui-icon-search"></i></button>
            </div>
            <div class="layui-inline">
                <button class="layui-btn" onclick="addNewSubclass()">添加小类</button>
            </div>
        </div>
        <#--<div class="layui-form-item">-->
        <#--<div class="layui-inline">-->
        <#--<label class="layui-form-label">商品大类</label>-->
        <#--<div class="layui-input-inline">-->
        <#--<select name="commodityTypeAdd" lay-filter="commodityTypeAdd" lay-verify="required">-->
        <#--<option value="">请选择</option>-->
        <#--</select>-->
        <#--</div>-->
        <#--</div>-->

        <#--</div>-->
    </div>
    <#--表格:显示商品小类-->
        <table id="Subclass" lay-filter="Subclass"></table>
    <#--商品小类的表单-->
    <form id="SubclassForm" class="layui-form SubclassForm layui-form-pane layui-personal" action=""
          lay-filter="SubclassForm" hidden="true">
        <div class="layui-form-item" hidden>
            <label class="layui-form-label">商品小类ID</label>
            <div class="layui-input-block">
                <input type="text" name="subclassID" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label xrequired">小类名称</label>
            <div class="layui-input-block">
                <input type="text" name="subclassName" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
        <#--<div class="layui-form-item">-->
        <#--<label class="layui-form-label xrequired">业绩</label>-->
        <#--<div class="layui-input-block">-->
        <#--<select name="subclassAchievement" lay-filter="subclassAchievement" lay-verify="required">-->
        <#--<option value="">请选择</option>-->
        <#--</select>-->
        <#--</div>-->
        <#--</div>-->
        <div class="layui-form-item">
            <label class="layui-form-label xrequired">所属行业</label>
            <div class="layui-input-inline">
                <select name="industryId" lay-filter="IndustryId" lay-verify="required">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label xrequired">商品大类</label>
            <div class="layui-input-block">
                <select id="commodityType" name="commodityType" lay-filter="commodityType" lay-verify="required">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label xrequired">职位分类</label>
            <div class="layui-input-block" id="post">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">客户评测</label>
            <div class="layui-input-block">
                <select name="subclassEvaluating" lay-filter="subclassEvaluating" lay-verify="required">
                </select>
            </div>
        </div>
        <div class="layui-form-item" hidden>
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="text" name="status" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" hidden>
            <label class="layui-form-label">创建时间</label>
            <div class="layui-input-block">
                <input type="text" name="createTime" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" hidden>
            <label class="layui-form-label">创建人</label>
            <div class="layui-input-block">
                <input type="text" name="createOperator" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" hidden>
            <label class="layui-form-label">修改人</label>
            <div class="layui-input-block">
                <input type="text" name="modifyOperator" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" hidden>
            <label class="layui-form-label">修改时间</label>
            <div class="layui-input-block">
                <input type="text" name="dataChangeLastTime" lay-verify="required" autocomplete="off" placeholder=""
                       class="layui-input">
            </div>
        </div>
    </form>
    <#--选择职位分类的提成方式和值-->
    <#-- <form id="postCategoryMethod" class="layui-form postCategoryMethod" action="" lay-filter="postCategoryMethod" hidden="true">
         <div class="layui-form-item">
             <label class="layui-form-label">提成方式</label>
             <div class="layui-input-inline">
                 <select name="method" lay-filter="method" lay-verify="required">
                     <option value="">请选择</option>
                     <option value="oneOrHalf">个数</option>
                     <option value="salemanProportion">比例</option>
                     </select>
             </div>
         </div>
         <div class="layui-form-item">
             <label class="layui-form-label">值</label>
             <div class="layui-input-inline">
                 <input type="text" name="takePercentage" lay-verify="required" autocomplete="off" placeholder="" class="layui-input">
             </div>
         </div>
     </form>-->
</div>

<#--小类按钮-->
<script type="text/html" id="SubclassDemo">
    <a class="layui-btn layui-btn-xs" lay-event="show">查看</a>
    <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<script>
    var dataAchievement, dataCommityType, dataEvaluating, dataPostCategory, table, form, postCategoryList = [];
    //数据显示,分页实现
    layui.use(['table', 'form'], function () {
        table = layui.table;
        form = layui.form;

        //加载行业
        loadData();
        loadIndustry();
        //加载业绩
        /* loadAchievement(storeId)*/
        table.render({
            elem: '#Subclass'
            , url: dataHost + "/commodityType/selectSubclassByCondition" //selectSubclassList
            , cellMinWidth: 60 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , page: true          //显示分页默认不显示
            , method: 'post'
            , request: {
                pageName: 'pageNum', //页码的参数名称，默认：page
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            }
            , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": 0, //解析接口状态
                    "msg": res.responseStatusType.error.errorMsg, //解析提示文本
                    "count": res.result == null ? 0 : res.result.total, //解析数据长度
                    "data": res.result == null ? 0 : res.result.list //解析数据列表
                }
            }
            , cols: [[
                {type: 'checkbox', fixed: 'left', width: 40, hide: true}
                , {field: 'subclassID', title: '序号', width: 75, sort: true, fixed: 'left'}
                , {field: 'subclassName', title: '小类'}
                // , {
                //     field: 'subclassAchievementID', title: '业绩', templet: function (d) {
                //         var achievement = "";
                //         for (var p in dataAchievement) {
                //             if (dataAchievement[p].achievementID == d.subclassAchievementID) {
                //                 achievement = dataAchievement[p].achievementName
                //             }
                //         }
                //         return achievement
                //     }, sort: true
                // }
                , {
                    field: 'commodityTypeID', title: '大类', templet: function (d) {
                        var commodity = ""
                        for (var p in dataCommityType) {
                            if (dataCommityType[p].commodityTypeID == d.commodityTypeID) {
                                commodity = dataCommityType[p].commodityTypeName;
                            }
                        }
                        return commodity;
                    }, sort: true
                }
                , {
                    field: 'postCategoryIds', title: '职位分类', templet: function (d) {
                        var voList = d.postCategoryVOList, post = "";
                        for (var i in voList) {
                            post = post + voList[i].postCategoryName + " ";
                        }
                        return post;
                    }, sort: true
                }
                , {
                    field: 'subclassEvaluatingID', title: '客户评测', templet: function (d) {
                        var evaluating = ""
                        for (var p in dataEvaluating) {
                            if (dataEvaluating[p].evaluatingID == d.subclassEvaluatingID) {
                                evaluating = dataEvaluating[p].evaluatingName;
                            }
                        }
                        return evaluating;
                    }, sort: true
                }
                , {
                    field: 'status', title: '状态', templet: function (d) {
                        if (d.status == 1) {
                            return "正常"
                        } else {
                            return "删除"
                        }
                    }
                }
                , {field: 'createOperator', title: '创建人'}
                , {field: 'createTime', title: '创建时间'}
                , {field: 'modifyOperator', title: '修改人'}
                , {field: 'dataChangeLastTime', title: '修改时间'}
                , {fixed: 'right', title: '操作', width: 180, align: 'center', toolbar: '#SubclassDemo'}
            ]]
            , id: 'SubclassReload'
        });

        //查看，编辑，删除
        table.on('tool(Subclass)', function (obj) {
            var data = obj.data;
            if (obj.event === 'edit') {
                editSubclass(data);
                // layer.msg('ID：'+ data.membershipLevelId + ' 的查看操作');
            } else if (obj.event === 'del') {
                layer.confirm('真的删除ID为' + data.subclassID + '的小类么？', function (index) {
                    delSubclass(data);
                    obj.del();
                });
                // layer.alert('编辑行：<br>'+ JSON.stringify(data))
            } else if (obj.event === 'show') {
                showSubclass(data);
                // layer.alert('编辑行：<br>'+ JSON.stringify(data))
            }
        });

        //职位(监听大类的选择，大类选择后获取大类的行业，获取行业职位分类)
        form.on('select(commodityType)', function (data) {
            $("#post").empty();
            var id = data.value;//大类id
            var inId;//行业id
            var productType;//商品分类
            for (var p in dataCommityType) {
                if (id == dataCommityType[p].commodityTypeID) {
                    inId = dataCommityType[p].commodityTypeIndustryID;
                    productType = dataCommityType[p].commodityProductType;
                }
            }
            if (productType == 1) { //产品
                $("#post").parent().hide();
            } else if (productType == 2) {   //服务
                $("#post").parent().show();
                var intresult = 0
                for (var p in dataPostCategory) {
                    if (dataPostCategory[p].industryID == inId) {
                        intresult++;
                        // var div = "<div id='" + dataPostCategory[p].postCategoryId + "' class='layui-input-block'>" +
                        //     // "    <label class='layui-form-label'>提成方式</label>" +
                        //     "      <div class='layui-input-inline' style='width:160px;'>" +
                        //     "         <select name='method' lay-filter='method' lay-verify='required' disabled>" +
                        //     "           <option value='0'>请选择提成方式</option>" +
                        //     "           <option value='oneOrHalf'>个数</option>" +
                        //     "           <option value='salemanProportion'>比例</option>" +
                        //     "          </select>" +
                        //     "        </div>" +
                        //     "         <div class='layui-input-block'>" +
                        //     "           <input type='text' name='takePercentage' lay-verify='required' autocomplete='off' placeholder='输入个数或比例' class='layui-input' style='width:120px;' disabled>" +
                        //     "         </div>" +
                        //     "    </div>";
                        var input = "<div class='layui-input-inline' style='width:90px;'>" +
                            "<input type='checkbox' name='" + dataPostCategory[p].postCategoryId + "' value='" + dataPostCategory[p].postCategoryId + "" +
                            "' lay-filter='post' ay-skin='primary' title='" + dataPostCategory[p].name + "'></div>";
                        $("#post").append(input);
                    }
                }

                if (intresult == 0) {
                    $("#post").html("<span style='color: red'>  选中的大类所属的行业暂未添加任何职位分类，请先添加</span>");
                }
            }
            // form.render('checkbox');
            form.render();
        });

        //监听行业联动大类
        form.on('select(IndustryId)', function (data) {
            loadCommodityType(data.value);
        })

        //监听表单复选框的选择
        form.on('checkbox(post)', function (data) {
            // console.log(data.elem); //得到checkbox原始DOM对象
            // console.log(data.elem.checked); //是否被选中，true或者false
            // console.log(data.value); //复选框value值，也可以通过data.elem.value得到
            // console.log(data.othis); //得到美化后的DOM对象
            var value = data.value, flag = data.elem.checked;
            if (flag) {   //选择了复选框
                //启用输入框和选择框
                $("#" + value + " select[name='method']").attr("disabled", false);
                $("#" + value + " input[name='takePercentage']").attr("disabled", false);
            } else {  //不选择复选框
                $("#" + value + " select[name='method']").attr("disabled", true);
                $("#" + value + " input[name='takePercentage']").attr("disabled", true);
            }
            form.render();
        });


        //搜索
        var $ = layui.$, active = {
            search: function () {
                var commodityTypeID = $(".demoTable select[name='commodityTypeSearch'] option:selected").val(),
                    // subclassAchievementID = $(".demoTable select[name='subclassAchievement'] option:selected").val(),
                    subclassEvaluatingID = $(".demoTable select[name='subclassEvaluating'] option:selected").val();
                var params = {
                    commodityTypeID: null,
                    subclassEvaluatingID: null
                };
                if (commodityTypeID != null && commodityTypeID != 0) {
                    params.commodityTypeID = commodityTypeID;
                }
                if (subclassEvaluatingID != null && subclassEvaluatingID != 0) {
                    params.subclassEvaluatingID = subclassEvaluatingID;
                }
                table.reload('SubclassReload', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    , where: params
                }, 'data');
            }
        };
        $('.demoTable .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });

    function editSubclass(data) {
        var a3 = layer.open({
            type: 1,
            title: '修改商品小类',
            content: $('#SubclassForm'),
            closeBtn: 1,
            btn: ['提交', '取消'],
            yes: function (index, layero) {
                postCategoryList = [];
                //遍历每个被选中的复选框
                $("#post input[type='checkbox']:checked").each(function (index, e) {
                    // var value = $(this).val();
                    var value = this.value;
                    var title = this.title;
                    //职位
                    var postCategory = {};
                    postCategory.postCategoryId = value;
                    postCategory.postCategoryName = title;
                    // postCategory.oneOrHalf = "";
                    // postCategory.salemanProportion = "";
                    // var method = $("#" + value + " select[name='method']").find("option:selected").val();
                    // var takePercentage = $("#" + value + " input[name='takePercentage']").val();
                    // postCategory[method] = takePercentage;
                    postCategoryList.push(postCategory);
                });
                // console.log(postCategoryList);
                var url = dataHost + "/commodityType/updateSubclass";
                //下拉框
                // var subclassAchievement = layero.find("select[name='subclassAchievement']");
                // subclassAchievement = subclassAchievement.find("option:selected").val();
                var subclassEvaluating = layero.find("select[name='subclassEvaluating']");
                subclassEvaluating = subclassEvaluating.find("option:selected").val();
                var commidity = layero.find("select[name='commodityType']");
                commidity = commidity.find("option:selected").val();
                var params = {
                    subclassID: data.subclassID,
                    subclassName: layero.find("input[name='subclassName']").val(),
                    // subclassAchievementID: subclassAchievement,
                    commodityTypeID: commidity,
                    postCategoryIds: JSON.stringify(postCategoryList),
                    subclassEvaluatingID: subclassEvaluating,
                    modifyOperator: "${currentUser.trueName!}"
                };
                $.post(url, params, function (res) {
                    if (res.responseStatusType.message == "Success") {
                        layer.open({
                            title: '修改'
                            , content: '修改成功！'
                            , btn: ["关闭"]
                            , yes: function (index) {
                                layer.close(index); //如果设定了yes回调，需进行手工关闭
                                layer.close(a3);
                            }
                        });
                        //重新加载表格
                        table.reload("SubclassReload");
                    } else {
                        layer.open({
                            title: '修改'
                            , content: '修改失败！' + res.responseStatusType.error.errorMsg
                            , btn: ["关闭"]
                        });
                    }
                })
                // layer.close(); //如果设定了yes回调，需进行手工关闭
            },
            btn2: function () {
                layer.close(a3);
            },
            success: function (layero) {
                var industryId;
                for (var i = 0; i < dataCommityType.length; i++) {
                    if (dataCommityType[i].commodityTypeID == data.commodityTypeID) {
                        industryId = dataCommityType[i].commodityTypeIndustryID
                    }
                }
                form.val("SubclassForm", {
                    "industryId":industryId,
                    "commodityType": data.commodityTypeID
                })
                layero.find("input[name='subclassName']").val(data.subclassName);
                var commodityTypeID = layero.find("select[name='commodityType']");
                commodityTypeID.find("option[value='" + data.commodityTypeID + "']").attr("selected", true);
                // var subclassAchievementID = layero.find("select[name='subclassAchievement']");
                // subclassAchievementID.find("option[value='" + data.subclassAchievementID + "']").attr("selected", true);
                var subclassEvaluating = layero.find("select[name='subclassEvaluating']");
                subclassEvaluating.find("option[value='" + data.subclassEvaluatingID + "']").attr("selected", true);
                //职位分类,根据商品大类中的行业id和职位分类中的行业id显示职位分类
                loadPostCategory(data.commodityTypeID);
                //职位选择
                var postList = data.postCategoryVOList;
                var jsonObj = {};
                for (var p in postList) {
                    jsonObj[postList[p].postCategoryId] = true;
                }
                form.val('SubclassForm', jsonObj);
                //职位分类的比例和值
                // $("#post input[type='checkbox']:checked").each(function (index, e) {
                //     //回显职位分类的比例和值
                //     var value = $(this).val();
                //     var method = "", takePercent = "";
                //     for (var p in postList) {
                //         if (value == postList[p].postCategoryId) {
                //             if (postList[p].oneOrHalf != null && postList[p].oneOrHalf != "") {
                //                 method = "oneOrHalf";
                //                 takePercent = postList[p].oneOrHalf;
                //             }
                //             if (postList[p].salemanProportion != null && postList[p].salemanProportion != "") {
                //                 method = "salemanProportion";
                //                 takePercent = postList[p].salemanProportion;
                //             }
                //         }
                //     }
                //     $("#" + value + " select[name='method']").find("option[value='" + method + "']").attr("selected", true);
                //     $("#" + value + " input[name='takePercentage']").val(takePercent);
                // });
                //显示商品大类
                layero.find("select[name='commodityType']").parent().parent().show();
                //编辑隐藏创建人和编辑人
                layero.find("input[name='createOperator']").parent().parent().hide();
                layero.find("input[name='modifyOperator']").parent().parent().hide();
                layero.find("input[name='status']").parent().parent().hide();
                layero.find("input[name='createTime']").parent().parent().hide();
                layero.find("input[name='dataChangeLastTime']").parent().parent().hide();
                form.render();
            },
            area: ['600px', '500px'],
            // end: function () {
            //     window.location.reload();
            // }
        });
    }

    function delSubclass(data) {
        //删除数据库数据
        var url = dataHost + "/commodityType/deleteSubclass";
        var params = {
            subclassID: data.subclassID,
            modifyOperator: "${currentUser.trueName!}"
        };
        $.post(url, params, function (res) {
            if (res.responseStatusType.message == "Success") {
                layer.open({
                    title: '删除'
                    , content: '删除成功！'
                    , btn: ["关闭"]
                });
                //重新加载表格
                table.reload("SubclassReload");
            } else {
                layer.open({
                    title: '删除'
                    , content: '删除失败！' + res.responseStatusType.error.errorMsg
                    , btn: ["关闭"]
                });
            }
        })
    }

    function showSubclass(data) {
        var a1 = layer.open({
            type: 1,
            title: '查看商品小类',
            content: $('#SubclassForm'),
            closeBtn: 1,
            btn: ['确定'],
            yes: function () {
                layer.close(a1);
            },
            success: function (layero) {
                var industryId;
                for (var i = 0; i < dataCommityType.length; i++) {
                    if (dataCommityType[i].commodityTypeID == data.commodityTypeID) {
                        industryId = dataCommityType[i].commodityTypeIndustryID
                    }
                }
                form.val("SubclassForm", {
                    "industryId":industryId,
                    "commodityType": data.commodityTypeID
                })
                layero.find("input[name='subclassName']").val(data.subclassName);
                var commodityTypeID = layero.find("select[name='commodityType']");
                commodityTypeID.find("option[value='" + data.commodityTypeID + "']").attr("selected", true);
                // var subclassAchievementID = layero.find("select[name='subclassAchievement']");
                // subclassAchievementID.find("option[value='" + data.subclassAchievementID + "']").attr("selected", true);
                var subclassEvaluating = layero.find("select[name='subclassEvaluating']");
                subclassEvaluating.find("option[value='" + data.subclassEvaluatingID + "']").attr("selected", true);
                //职位分类,根据商品大类中的行业id和职位分类中的行业id显示职位分类
                loadPostCategory(data.commodityTypeID);
                //显示职位
                var postList = data.postCategoryVOList;
                var jsonObj = {};
                for (var p in postList) {
                    jsonObj[postList[p].postCategoryId] = true;
                }
                form.val('SubclassForm', jsonObj);
                //职位分类的比例和值
                // $("#post input[type='checkbox']:checked").each(function (index, e) {
                //     //回显职位分类的比例和值
                //     var value = $(this).val();
                //     var method = "", takePercent = "";
                //     for (var p in postList) {
                //         if (value == postList[p].postCategoryId) {
                //             if (postList[p].oneOrHalf != null && postList[p].oneOrHalf != "") {
                //                 method = "oneOrHalf";
                //                 takePercent = postList[p].oneOrHalf;
                //             }
                //             if (postList[p].salemanProportion != null && postList[p].salemanProportion != "") {
                //                 method = "salemanProportion";
                //                 takePercent = postList[p].salemanProportion;
                //             }
                //         }
                //     }
                //     $("#" + value + " select[name='method']").find("option[value='" + method + "']").attr("selected", true);
                //     $("#" + value + " input[name='takePercentage']").val(takePercent);
                // });
                //显示商品大类
                layero.find("select[name='commodityType']").parent().parent().show();
                if (data.status == 1) {
                    layero.find("input[name='status']").val("正常");
                } else {
                    layero.find("input[name='status']").val("删除");
                }
                layero.find("input[name='createOperator']").val(data.createOperator);
                layero.find("input[name='createTime']").val(data.createTime);
                layero.find("input[name='modifyOperator']").val(data.modifyOperator);
                layero.find("input[name='dataChangeLastTime']").val(data.dataChangeLastTime);
                //查看显示创建人和编辑人
                layero.find("input[name='createOperator']").parent().parent().show();
                layero.find("input[name='modifyOperator']").parent().parent().show();
                layero.find("input[name='status']").parent().parent().show();
                layero.find("input[name='createTime']").parent().parent().show();
                layero.find("input[name='dataChangeLastTime']").parent().parent().show();
                form.render();
            },
            area: ['600px', '500px'],
            // end: function () {
            //     window.location.reload();
            // }
        });
    }

    function addNewSubclass() {
        // //获取商品大类的值
        // var commidity = $(".demoTable select[name='commodityTypeAdd'] option:selected").val();
        loadIndustry();
        $("select[name='commodityType']").empty();
        $("#post").empty();
        var a2 = layer.open({
            type: 1,
            title: '添加商品小类',
            content: $('#SubclassForm'),
            closeBtn: 1,
            btn: ['提交', '取消'],
            yes: function (index, layero) {
                var commidity = layero.find("select[name='commodityType']");
                commidity = commidity.find("option:selected").val();
                //大类的选择
                if (commidity == null || commidity == 0) {
                    layer.msg("请选择商品大类");
                    return;
                }
                postCategoryList = [];
                //遍历每个被选中的复选框
                $("#post input[type='checkbox']:checked").each(function (index, e) {
                    // var value = $(this).val();
                    var value = this.value;
                    var title = this.title;
                    //职位
                    var postCategory = {};
                    postCategory.postCategoryId = value;
                    postCategory.postCategoryName = title;
                    // postCategory.oneOrHalf = "";
                    // postCategory.salemanProportion = "";
                    // var method = $("#" + value + " select[name='method']").find("option:selected").val();
                    // var takePercentage = $("#" + value + " input[name='takePercentage']").val();
                    // postCategory[method] = takePercentage;
                    postCategoryList.push(postCategory);
                });
                // console.log(postCategoryList);
                var url = dataHost + "/commodityType/insertSubclass";
                //下拉框
                // var subclassAchievement = layero.find("select[name='subclassAchievement']");
                // subclassAchievement = subclassAchievement.find("option:selected").val();
                var subclassEvaluating = layero.find("select[name='subclassEvaluating']");
                subclassEvaluating = subclassEvaluating.find("option:selected").val();
                var params = {
                    subclassName: layero.find("input[name='subclassName']").val(),
                    // subclassAchievementID: subclassAchievement,
                    commodityTypeID: commidity,
                    postCategoryIds: JSON.stringify(postCategoryList),
                    subclassEvaluatingID: subclassEvaluating,
                    createOperator: "${currentUser.trueName!}",
                    modifyOperator: "${currentUser.trueName!}"
                };
                $.post(url, params, function (res) {
                    if (res.responseStatusType.message == "Success") {
                        layer.open({
                            title: '添加'
                            , content: '添加成功！'
                            , btn: ["关闭"]
                            , yes: function (index) {
                                layer.close(index); //如果设定了yes回调，需进行手工关闭
                                layer.close(a2);
                            }
                        });
                        //重新加载表格
                        table.reload("SubclassReload");
                    } else {
                        layer.open({
                            title: '添加'
                            , content: '添加失败！' + res.responseStatusType.error.errorMsg
                            , btn: ["关闭"]
                        });
                    }
                })
                // layer.close(); //如果设定了yes回调，需进行手工关闭
            },
            btn2: function () {
                layer.close(a2);
            },
            success: function (layero) {
                layero.find("input[name='subclassName']").val("");
                // layero.find("select[name='subclassAchievement']").find("option[value='0']").attr("selected", true);
                layero.find("select[name='subclassEvaluating']").find("option[value='0']").attr("selected", true);
                form.render("select", "SubclassForm");
                //职位分类,根据商品大类中的行业id和职位分类中的行业id显示职位分类
                // loadPostCategory(commidity); 暂无
                //隐藏商品大类
                // layero.find("select[name='commodityType']").parent().parent().hide();
                //新增隐藏创建人和编辑人
                layero.find("input[name='createOperator']").parent().parent().hide();
                layero.find("input[name='modifyOperator']").parent().parent().hide();
                layero.find("input[name='status']").parent().parent().hide();
                layero.find("input[name='createTime']").parent().parent().hide();
                layero.find("input[name='dataChangeLastTime']").parent().parent().hide();

            },
            area: ['600px', '500px'],
            end: function () {
                loadCommodityType();
            }
        });
    }

    function loadPostCategory(commidity) {
        //职位分类,根据商品大类中的行业id和职位分类中的行业id显示职位分类
        $("#post").empty();
        var inId;//行业id
        for (var p in dataCommityType) {
            if (commidity == dataCommityType[p].commodityTypeID) {
                inId = dataCommityType[p].commodityTypeIndustryID;
            }
        }
        var intresult = 0
        for (var p in dataPostCategory) {
            if (dataPostCategory[p].industryID == inId) {
                intresult++
                // var div = "<div id='" + dataPostCategory[p].postCategoryId + "' class='layui-input-block'>" +
                //     // "    <label class='layui-form-label'>提成方式</label>" +
                //     "      <div class='layui-input-inline' style='width:160px;'>" +
                //     "         <select name='method' lay-filter='method' lay-verify='required' disabled>" +
                //     "           <option value='0'>请选择提成方式</option>" +
                //     "           <option value='oneOrHalf'>个数</option>" +
                //     "           <option value='salemanProportion'>比例</option>" +
                //     "          </select>" +
                //     "        </div>" +
                //     "         <div class='layui-input-block'>" +
                //     "           <input type='text' name='takePercentage' lay-verify='required' autocomplete='off' placeholder='输入个数或比例' class='layui-input' style='width:120px;' disabled>" +
                //     "         </div>" +
                //     "    </div>";
                var input = "<div class='layui-input-inline' style='width:90px;'>" +
                    "<input type='checkbox' name='" + dataPostCategory[p].postCategoryId + "' value='" + dataPostCategory[p].postCategoryId + "" +
                    "' lay-filter='post' ay-skin='primary' title='" + dataPostCategory[p].name + "'></div>";
                // $("#post").append(input + div);
                $("#post").append(input);
            }
        }
        if (intresult == 0) {
            $("#post").html("<span style='color: red'>  选中的大类所属的行业暂未添加任何职位分类，请先添加</span>");
        }
        // form.render('checkbox');
        form.render();
    }

    function loadData() {
        //请求职位数据 selectPostNoPage
        $.ajax({
            url: storeHost + "/manage/beautician/selectPostCategoryNoPage",
            // data: param,
            method: "POST",
            async: false,
            success: function (res) {
                if (res.responseStatusType.message == "Success") {
                    dataPostCategory = res.result;
                    var list = dataPostCategory;    //返回的数据
                    $("select[name='industryId']").empty();
                    var option1 = "<option value='' selected='selected'>请选择</option>";
                    $("select[name='industryId']").append(option1);
                    for (var p in list) {
                        var option = "<option value='" + list[p].industryID + "'>" + list[p].industryName + "</option>";
                        $("select[name='industryId']").append(option);
                    }
                    layui.form.render();
                }
            }
        });
        //请求业绩数据
        // $.ajax({
        //     url: dataHost + "/performance/selectPerformanceList",
        //     data: {storeId: storeId},
        //     method: "POST",
        //     async: false,
        //     success: function (res) {
        //         if (res.responseStatusType.message == "Success") {
        //             dataAchievement = res.result.list;
        //         }
        //     }
        // });
        //请求客户评测数据
        $.ajax({
            url: dataHost + "/evaluating/selectEvaluatingList",
            // data: param,
            method: "POST",
            async: false,
            success: function (res) {
                if (res.responseStatusType.message == "Success") {
                    dataEvaluating = res.result.list;
                }
            }
        });
        //请求商品大类数据
        $.ajax({
            url: dataHost + "/commodityType/selectCommodityTypeList",
            data: {"isDingzhi": 0},
            method: "POST",
            async: false,
            success: function (res) {
                if (res.responseStatusType.message == "Success") {
                    dataCommityType = res.result.list;
                }
            }
        });

        $("#SubclassForm select[name='commodityType']").html("<option value='0'>请选择</option>");
        // $("#SubclassForm select[name='subclassAchievement']").val("<option value='0' checked>请选择</option>");
        $("#SubclassForm select[name='subclassEvaluating']").html("<option value='0'>请选择</option>");
        // $("#SubclassForm select[name='post']").val("<option value='0' checked>请选择</option>");
        $(".demoTable select[name='commodityTypeSearch']").val("<option value='0'>请选择</option>");
        // $(".demoTable select[name='commodityTypeAdd']").val("<option value='0'>请选择</option>");
        // $(".demoTable select[name='subclassAchievement']").val("<option value='0'>请选择</option>");
        $(".demoTable select[name='subclassEvaluating']").val("<option value='0'>请选择</option>");
        // for (var p in dataAchievement) {
        //     var option = "<option value='" + dataAchievement[p].achievementID + "'>" + dataAchievement[p].achievementName + "</option>";
        //     $("#SubclassForm select[name='subclassAchievement']").append(option);
        //     $(".demoTable select[name='subclassAchievement']").append(option);
        // }
        for (var p in dataCommityType) {
            var option = "<option value='" + dataCommityType[p].commodityTypeID + "'>" + dataCommityType[p].commodityTypeName + "</option>";
            $("#SubclassForm select[name='commodityType']").append(option);
            $(".demoTable select[name='commodityTypeSearch']").append(option);
            // $(".demoTable select[name='commodityTypeAdd']").append(option);
        }
        for (var p in dataEvaluating) {
            var option = "<option value='" + dataEvaluating[p].evaluatingID + "'>" + dataEvaluating[p].evaluatingName + "</option>";
            $("#SubclassForm select[name='subclassEvaluating']").append(option);
            $(".demoTable select[name='subclassEvaluating']").append(option);
        }
        form.render("select", "SubclassForm");
        form.render("select", "demoTable");
    }

    /* function loadAchievement(storeId) {
         var param = {storeId:storeId}
         $.ajax({
             url: dataHost + "/performance/selectPerformanceList",
             data: param,
             method: "POST",
             async: false,
             success: function (res) {
                 if (res.responseStatusType.message == "Success") {
                     dataAchievement = res.result.list;
                     var server = document.getElementById("subclassAchievement"); //server为select定义的id
                     server.innerHTML = "<option value='0' selected='selected'>请选择</option>";
                     for (var p in dataAchievement) {
                         var option = document.createElement("option");  // 创建添加option属性
                         option.setAttribute("value", dataAchievement[p].id); // 给option的value添加值
                         option.innerText = dataAchievement[p].achievementName;     // 打印option对应的纯文本
                         server.appendChild(option);           //给select添加option子标签
                     }
                     form.render("select");
                 }else{
                     $("#achievement").find("option").remove();
                     form.render("select");
                 }
             }
         });
     }*/


    //加载行业
    function loadIndustry() {
        $("select[name='industryId']").empty();
        var url = storeHost + "/manage/industry/selectListIndustryNoPage";
        $.post(url, function (result) {
            if (result.responseStatusType.message == "Success") {
                var list = result.result;    //返回的数据
                var option1 = "<option value='' selected='selected'>请选择</option>";
                $("select[name='industryId']").append(option1);
                for (var p in list) {
                    var option = "<option value='" + list[p].industryID + "'>" + list[p].industryName + "</option>";
                    $("select[name='industryId']").append(option);
                }
                layui.form.render();
            }
        })
    }

    function loadCommodityType(id) {
        var param;
        if (typeof (id) != 'undefined') {
            param = {commodityTypeIndustryID:id};
        }
        //请求商品大类数据
        $.ajax({
            url: dataHost + "/commodityType/selectCommodityTypeList",
            method: "POST",
            data:param,
            async: false,
            success: function (res) {
                if (res.responseStatusType.message == "Success") {
                    $("#commodityType").empty();
                    var list = res.result.list;
                    var option1 = "<option value='' selected='selected'>请选择</option>";
                    $("select[name='commodityType']").append(option1);
                    for (var p in list) {
                        var option = "<option value='" + list[p].commodityTypeID + "'>" + list[p].commodityTypeName + "</option>";
                        $("select[name='commodityType']").append(option);
                    }
                    layui.form.render();
                }
            }
        });
    }
</script>
</body>
</html>